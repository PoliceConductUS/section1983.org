---
import Base from "../layouts/Base.astro";
---

<Base
  title="Search"
  description="Search articles, cases, primer entries, and process guides on section1983.org."
>
  <h1 class="text-3xl font-bold text-navy mb-6">Search</h1>

  <div class="mb-8">
    <label for="search-input" class="sr-only">Search the site</label>
    <input
      id="search-input"
      type="search"
      placeholder="Search cases, articles, primer terms, process steps... (try 'tased' or 'beaten')"
      autocomplete="off"
      class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg text-navy focus:border-gold focus:outline-none text-lg"
    />
  </div>

  <div
    id="search-results"
    class="space-y-4"
    role="region"
    aria-live="polite"
    aria-label="Search results"
  >
    <p class="text-slate-500">Type to search across all content.</p>
  </div>

  <script is:inline>
    const input = document.getElementById("search-input");
    const results = document.getElementById("search-results");
    let index = null;

    const typeLabels = {
      article: "Article",
      primer: "Primer",
      process: "Process",
      case: "Case",
    };
    const typeColors = {
      article: "bg-gold/20 text-navy",
      primer: "bg-navy/10 text-navy",
      process: "bg-green-100 text-green-800",
      case: "bg-red-50 text-red-800",
    };

    async function loadIndex() {
      if (index) return index;
      const res = await fetch("/search.json");
      index = await res.json();
      return index;
    }

    function search(query) {
      if (!index) return [];
      const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
      if (!terms.length) return [];
      return index
        .filter((item) => {
          const haystack = (
            item.title +
            " " +
            item.description +
            " " +
            (item.tags || []).join(" ")
          ).toLowerCase();
          return terms.every((t) => haystack.includes(t));
        })
        .slice(0, 20);
    }

    function render(items, query) {
      if (!query.trim()) {
        results.innerHTML =
          '<p class="text-slate-500">Type to search across all content.</p>';
        return;
      }
      if (!items.length) {
        results.innerHTML =
          '<p class="text-slate-500">No results found. Try different terms.</p>';
        return;
      }
      results.innerHTML = items
        .map(
          (item) => `
        <a href="${item.url}" class="block p-4 bg-white rounded border border-slate-200 hover:border-gold hover:shadow-sm transition-all">
          <div class="flex items-center gap-2 mb-1">
            <span class="text-xs font-bold px-2 py-0.5 rounded ${typeColors[item.type] || ""}">${typeLabels[item.type] || item.type}</span>
            <span class="font-semibold text-navy">${item.title}</span>
          </div>
          <p class="text-sm text-slate-500">${item.description}</p>
        </a>
      `,
        )
        .join("");
    }

    let debounce;
    input.addEventListener("input", () => {
      clearTimeout(debounce);
      debounce = setTimeout(async () => {
        await loadIndex();
        render(search(input.value), input.value);
      }, 150);
    });

    // Auto-focus search input
    input.focus();

    // Support ?q= query param
    const params = new URLSearchParams(window.location.search);
    const q = params.get("q");
    if (q) {
      input.value = q;
      loadIndex().then(() => render(search(q), q));
    }
  </script>
</Base>
